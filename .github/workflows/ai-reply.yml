# AIê°€ PR ì½”ë©˜íŠ¸ ì§ˆë¬¸ì— ë‹µë³€
name: ai-reply

on:
  # PR ì½”ë“œ ë¦¬ë·° ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë§Œ ì§€ì›
  pull_request_review_comment:
    types: [created]

env:
  TARGET_BRANCH: main

jobs:
  ai-reply:
    runs-on: ubuntu-latest
    # @aië¡œ ì‹œì‘í•˜ëŠ” review commentë§Œ ì²˜ë¦¬
    if: startsWith(github.event.comment.body, '@ai')

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMENT_ID=${{ github.event.comment.id }}

          # PRì˜ head SHA ê°€ì ¸ì˜¤ê¸°
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

      # ì½”ë©˜íŠ¸ê°€ AI ë¦¬ë·° ì½”ë©˜íŠ¸ì— ëŒ€í•œ ë‹µê¸€ì¸ì§€ í™•ì¸
      - name: Check if reply to AI comment
        id: check-reply
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.number }}
          COMMENT_ID=${{ steps.pr-info.outputs.comment_id }}

          # í˜„ì¬ ì½”ë©˜íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          COMMENT_DATA=$(gh api repos/${{ github.repository }}/pulls/comments/$COMMENT_ID)

          # in_reply_to_idê°€ ìˆëŠ”ì§€ í™•ì¸
          IN_REPLY_TO=$(echo "$COMMENT_DATA" | jq -r '.in_reply_to_id // empty')

          if [ -z "$IN_REPLY_TO" ]; then
            # ì§ì ‘ ë‹µê¸€ì´ ì•„ë‹ˆë©´, ê°™ì€ ë¼ì¸ì˜ AI ì½”ë©˜íŠ¸ ì°¾ê¸°
            PATH_FILE=$(echo "$COMMENT_DATA" | jq -r '.path')
            LINE_NUM=$(echo "$COMMENT_DATA" | jq -r '.line // .original_line')

            # ê°™ì€ íŒŒì¼, ê°™ì€ ë¼ì¸ì˜ AI ì½”ë©˜íŠ¸ ì°¾ê¸°
            PARENT_COMMENT=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
              --jq ".[] | select(.path == \"$PATH_FILE\" and (.line == $LINE_NUM or .original_line == $LINE_NUM) and (.body | startswith(\"ğŸ¤–\"))) | .id" \
              | head -1)

            if [ -n "$PARENT_COMMENT" ]; then
              IN_REPLY_TO=$PARENT_COMMENT
            fi
          fi

          if [ -z "$IN_REPLY_TO" ]; then
            echo "âŒ AI ì½”ë©˜íŠ¸ì— ëŒ€í•œ ë‹µê¸€ì´ ì•„ë‹™ë‹ˆë‹¤"
            echo "is_reply=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ì›ë³¸ AI ì½”ë©˜íŠ¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
          PARENT_DATA=$(gh api repos/${{ github.repository }}/pulls/comments/$IN_REPLY_TO)
          PARENT_BODY=$(echo "$PARENT_DATA" | jq -r '.body')

          # AIê°€ ì‘ì„±í•œ ì½”ë©˜íŠ¸ì¸ì§€ í™•ì¸
          if [[ ! "$PARENT_BODY" =~ ^ğŸ¤– ]]; then
            echo "âŒ AIê°€ ì‘ì„±í•œ ì½”ë©˜íŠ¸ê°€ ì•„ë‹™ë‹ˆë‹¤"
            echo "is_reply=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "is_reply=true" >> $GITHUB_OUTPUT
          echo "parent_comment_id=$IN_REPLY_TO" >> $GITHUB_OUTPUT

          # íŒŒì¼ ê²½ë¡œì™€ ë¼ì¸ ë²ˆí˜¸ ì €ì¥
          PATH_FILE=$(echo "$PARENT_DATA" | jq -r '.path')
          LINE_NUM=$(echo "$PARENT_DATA" | jq -r '.line // .original_line')

          echo "file_path=$PATH_FILE" >> $GITHUB_OUTPUT
          echo "line_number=$LINE_NUM" >> $GITHUB_OUTPUT

          # ì›ë³¸ ì½”ë©˜íŠ¸ ë‚´ìš© ì €ì¥
          echo "$PARENT_BODY" > /tmp/parent_comment.txt

      # AI ë‹µë³€ ìƒì„± (Gemini API ì§ì ‘ í˜¸ì¶œ)
      - name: Generate AI reply
        if: steps.check-reply.outputs.is_reply == 'true'
        id: generate-reply
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/ai-reply-direct.sh \
            "${{ steps.pr-info.outputs.head_sha }}" \
            "${{ steps.check-reply.outputs.file_path }}" \
            "${{ steps.check-reply.outputs.line_number }}" \
            "${{ github.event.comment.body }}"

      # ë‹µë³€ ì½”ë©˜íŠ¸ ì‘ì„±
      - name: Post AI reply
        if: steps.check-reply.outputs.is_reply == 'true'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.number }}
          PARENT_ID=${{ steps.check-reply.outputs.parent_comment_id }}

          if [ ! -f "ai_reply.txt" ]; then
            echo "âŒ AI ë‹µë³€ íŒŒì¼ ì—†ìŒ"
            exit 1
          fi

          REPLY_BODY=$(cat ai_reply.txt)

          # ë‹µê¸€ ì‘ì„±
          gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
            -X POST \
            -f body="$REPLY_BODY" \
            -f commit_id="${{ steps.pr-info.outputs.head_sha }}" \
            -f path="${{ steps.check-reply.outputs.file_path }}" \
            -F line=${{ steps.check-reply.outputs.line_number }} \
            -f side="RIGHT" \
            -F in_reply_to=$PARENT_ID

          echo "âœ… AI ë‹µë³€ ì‘ì„± ì™„ë£Œ"
