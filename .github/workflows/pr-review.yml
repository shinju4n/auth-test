# PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ AIê°€ ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ ìž‘ì„±
name: pr-review

on:
  pull_request:
    types: [opened, synchronize]  # PR ìƒì„± + ìƒˆ ì»¤ë°‹ ì¶”ê°€
    branches: [main]

env:
  TARGET_BRANCH: main

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    # dev â†’ main PRë§Œ ì²˜ë¦¬
    if: github.event.pull_request.head.ref == 'dev'

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # opened ì´ë²¤íŠ¸: ì „ì²´ PR diff
          # synchronize ì´ë²¤íŠ¸: ìƒˆ ì»¤ë°‹ë§Œ
          if [ "${{ github.event.action }}" = "opened" ]; then
            BEFORE_SHA="${{ github.event.pull_request.base.sha }}"
            AFTER_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BEFORE_SHA="${{ github.event.before }}"
            AFTER_SHA="${{ github.event.after }}"
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "before=$BEFORE_SHA" >> $GITHUB_OUTPUT
          echo "after=$AFTER_SHA" >> $GITHUB_OUTPUT

      # Gemini CLI ì„¤ì¹˜
      - name: Install Gemini CLI
        run: |
          npm install -g @google/gemini-cli

      # AI ì½”ë“œ ë¦¬ë·° ë¶„ì„
      - name: Analyze code changes
        id: analyze
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_OUTPUT: ${{ github.output }}
        run: |
          bash .github/scripts/analyze-code-review.sh \
            ${{ steps.pr-info.outputs.before }} \
            ${{ steps.pr-info.outputs.after }}

      # ê¸°ì¡´ ë¦¬ë·° ì½”ë©˜íŠ¸ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
      - name: Get existing review comments
        id: existing-comments
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.number }}

          # PRì˜ ê¸°ì¡´ ë¦¬ë·° ì½”ë©˜íŠ¸ ê°€ì ¸ì˜¤ê¸° (AIê°€ ìž‘ì„±í•œ ê²ƒë§Œ)
          gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
            --jq '[.[] | select(.body | startswith("ðŸ¤–")) | {path: .path, line: .line, body: .body}]' \
            > existing_comments.json

          echo "AI ì½”ë©˜íŠ¸ ê°œìˆ˜: $(cat existing_comments.json | jq 'length')"

      # ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ ìž‘ì„±
      - name: Post review comments
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.number }}
          COMMIT_SHA=${{ steps.pr-info.outputs.after }}

          # analyze-code-review.shê°€ ìƒì„±í•œ ë¦¬ë·° ê²°ê³¼ íŒŒì¼ ì½ê¸°
          if [ ! -f "review_comments.json" ]; then
            echo "ë¦¬ë·° ì½”ë©˜íŠ¸ ì—†ìŒ"
            exit 0
          fi

          # JSON ë°°ì—´ í˜•íƒœ: [{path, line, body, severity}, ...]
          COMMENTS=$(cat review_comments.json)
          COMMENT_COUNT=$(echo "$COMMENTS" | jq 'length')

          echo "ìž‘ì„±í•  ì½”ë©˜íŠ¸ ê°œìˆ˜: $COMMENT_COUNT"

          if [ "$COMMENT_COUNT" -eq 0 ]; then
            echo "âœ… ë¦¬ë·°í•  ì´ìŠˆ ì—†ìŒ"
            exit 0
          fi

          # ê° ì½”ë©˜íŠ¸ ìž‘ì„±
          echo "$COMMENTS" | jq -c '.[]' | while read -r comment; do
            FILE_PATH=$(echo "$comment" | jq -r '.path')
            LINE=$(echo "$comment" | jq -r '.line')
            BODY=$(echo "$comment" | jq -r '.body')
            SEVERITY=$(echo "$comment" | jq -r '.severity')

            # ì¤‘ë³µ í™•ì¸: ê°™ì€ íŒŒì¼, ê°™ì€ ë¼ì¸ì— ì´ë¯¸ ì½”ë©˜íŠ¸ê°€ ìžˆëŠ”ì§€
            EXISTING=$(cat existing_comments.json | jq -r --arg path "$FILE_PATH" --arg line "$LINE" \
              '.[] | select(.path == $path and (.line | tostring) == $line) | .body')

            if [ -n "$EXISTING" ]; then
              echo "â­ï¸  ì¤‘ë³µ ì½”ë©˜íŠ¸ ìŠ¤í‚µ: $FILE_PATH:$LINE"
              continue
            fi

            # Critical, Highë§Œ ì½”ë©˜íŠ¸ ìž‘ì„±
            if [ "$SEVERITY" != "critical" ] && [ "$SEVERITY" != "high" ]; then
              echo "â­ï¸  ë‚®ì€ ì‹¬ê°ë„ ìŠ¤í‚µ: $FILE_PATH:$LINE ($SEVERITY)"
              continue
            fi

            echo "ðŸ’¬ ì½”ë©˜íŠ¸ ìž‘ì„±: $FILE_PATH:$LINE [$SEVERITY]"

            # ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ ìž‘ì„±
            gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
              -X POST \
              -f body="$BODY" \
              -f commit_id="$COMMIT_SHA" \
              -f path="$FILE_PATH" \
              -F line=$LINE \
              -f side="RIGHT" || echo "âš ï¸  ì½”ë©˜íŠ¸ ìž‘ì„± ì‹¤íŒ¨ (íŒŒì¼ì´ diffì— ì—†ì„ ìˆ˜ ìžˆìŒ)"
          done

          echo "âœ… AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ"

      # ë¦¬ë·° ì™„ë£Œ ìš”ì•½ ì½”ë©˜íŠ¸ (ì„ íƒ)
      - name: Post review summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.number }}

          if [ -f "review_comments.json" ]; then
            TOTAL=$(cat review_comments.json | jq 'length')
            CRITICAL=$(cat review_comments.json | jq '[.[] | select(.severity == "critical")] | length')
            HIGH=$(cat review_comments.json | jq '[.[] | select(.severity == "high")] | length')
            AFTER_SHA="${{ steps.pr-info.outputs.after }}"

            # heredoc ëŒ€ì‹  echo ë¸”ë¡ ì‚¬ìš©
            {
              echo "## ðŸ¤– AI ì½”ë“œ ë¦¬ë·° ì™„ë£Œ"
              echo ""
              echo "**ë¶„ì„ ê²°ê³¼**:"
              echo "- ðŸ”´ Critical: ${CRITICAL}ê°œ"
              echo "- ðŸŸ  High: ${HIGH}ê°œ"
              echo "- ðŸ“Š ì „ì²´ ì´ìŠˆ: ${TOTAL}ê°œ"
              echo ""
              echo "_ë¦¬ë·° ì´ˆì : ì„±ëŠ¥, ë³´ì•ˆ, SOLID/DRY/YAGNI/KISS ì›ì¹™_"
              echo "_ìƒˆ ì»¤ë°‹: \`${AFTER_SHA}\`_"
            } > summary.md

            gh pr comment $PR_NUMBER --body-file summary.md
            rm -f summary.md
          fi
