# dev ë¸Œëœì¹˜ì— pushë˜ë©´ ìë™ìœ¼ë¡œ PR ìƒì„±
name: create-pr

on:
  push:
    branches: [dev]

env:
  TARGET_BRANCH: main # PR ìƒì„±í•  ëŒ€ìƒ ë¸Œëœì¹˜ (ë³€ê²½ ê°€ëŠ¥)

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ì´ë¯¸ ì—´ë¦° PRì´ ìˆëŠ”ì§€ í™•ì¸
      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          existing_pr=$(gh pr list --head dev --base ${{ env.TARGET_BRANCH }} --json number --jq '.[0].number')
          if [ -n "$existing_pr" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR already exists: #$existing_pr"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      # Gemini CLI ì„¤ì¹˜ (PRì´ ì—†ì„ ë•Œë§Œ)
      - name: Install Gemini CLI
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          npm install -g @google/gemini-cli

      # Geminië¡œ PR ì œëª©ê³¼ ì„¤ëª… ìƒì„± (PRì´ ì—†ì„ ë•Œë§Œ)
      - name: Generate PR Title and Description
        if: steps.check-pr.outputs.exists == 'false'
        id: generate-pr
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_OUTPUT: ${{ github.output }}
        run: |
          # mainê³¼ dev ë¸Œëœì¹˜ ì°¨ì´ë§Œ ë¶„ì„
          bash .github/scripts/generate-pr-description.sh \
            ${{ env.TARGET_BRANCH }} \
            dev

      # ê¸°ì¡´ PRì´ ì—†ì„ ë•Œë§Œ ìƒˆë¡œ ìƒì„±
      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          TZ: Asia/Seoul
          PR_BODY: ${{ steps.generate-pr.outputs.body }}
        run: |
          # í˜„ì¬ ì‹œê°„ ìƒì„± (KST)
          CURRENT_TIME=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')

          # PR bodyë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œë¶€í„° íŒŒì¼ì— ì €ì¥ (backtick ë³´ì¡´)
          echo "$PR_BODY" > pr_body.md

          # AI-MANAGED ì„¹ì…˜ ì¶”ê°€ (update-pr.ymlì´ ì´ ì˜ì—­ì„ ì—…ë°ì´íŠ¸)
          cat >> pr_body.md << EOF

          <!-- AI-MANAGED-START -->
          <!-- ì´ ì„¹ì…˜ì€ AIê°€ ìë™ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤. PR ì—…ë°ì´íŠ¸ ì‹œ ìƒˆ ë³€ê²½ì‚¬í•­ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
          <!-- AI-MANAGED-END -->

          ---
          _ğŸ¤– AIë¡œ ìë™ ìƒì„±ëœ PR (ì œëª© + ì„¤ëª…)_
          _ìƒì„± ì‹œê°„: ${CURRENT_TIME}_
          _ì»¤ë°‹ SHA: ${{ github.sha }}_
          EOF

          # íŒŒì¼ì—ì„œ ì½ì–´ì„œ PR ìƒì„±
          gh pr create \
            --base ${{ env.TARGET_BRANCH }} \
            --head dev \
            --title "${{ steps.generate-pr.outputs.title }}" \
            --body-file pr_body.md
