# PRì— ìƒˆ ì»¤ë°‹ì´ ì¶”ê°€ë˜ë©´ ìë™ìœ¼ë¡œ ë³¸ë¬¸ ì—…ë°ì´íŠ¸
name: update-pr

on:
  pull_request:
    types: [synchronize] # PRì— ìƒˆ ì»¤ë°‹ pushë  ë•Œ
    branches: [main]

env:
  TARGET_BRANCH: main

jobs:
  update-pull-request:
    runs-on: ubuntu-latest
    # dev ë¸Œëœì¹˜ì—ì„œ mainìœ¼ë¡œ ê°€ëŠ” PRë§Œ ì²˜ë¦¬
    if: github.event.pull_request.head.ref == 'dev'

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # í˜„ì¬ PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: Get current PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_BODY=$(gh pr view $PR_NUMBER --json body --jq '.body')

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Gemini CLI ì„¤ì¹˜
      - name: Install Gemini CLI
        run: |
          npm install -g @google/gemini-cli

      # ìƒˆë¡œìš´ ì»¤ë°‹ë§Œ ë¶„ì„ (ì´ì „ ì»¤ë°‹ ~ ìµœì‹  ì»¤ë°‹)
      - name: Analyze new commits
        id: analyze
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_OUTPUT: ${{ github.output }}
        run: |
          # before: PR ì—…ë°ì´íŠ¸ ì „ ë§ˆì§€ë§‰ ì»¤ë°‹
          # after: PR ì—…ë°ì´íŠ¸ í›„ ìµœì‹  ì»¤ë°‹
          bash .github/scripts/analyze-pr-updates.sh \
            ${{ github.event.before }} \
            ${{ github.event.after }}

      # PR ë³¸ë¬¸ì˜ AI-MANAGED ì„¹ì…˜ ì—…ë°ì´íŠ¸
      - name: Update PR body
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          TZ: Asia/Seoul
          PR_BODY: ${{ steps.pr-info.outputs.body }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}
          NEW_CHANGES: ${{ steps.analyze.outputs.changes }}
        run: |
          CURRENT_TIME=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')

          # AI-MANAGED ì„¹ì…˜ì— ìƒˆ ë³€ê²½ì‚¬í•­ ì¶”ê°€
          # ê¸°ì¡´ ë³¸ë¬¸ì—ì„œ AI-MANAGED-START ~ AI-MANAGED-END ì˜ì—­ ì°¾ê¸°
          if echo "$PR_BODY" | grep -q "<!-- AI-MANAGED-START -->"; then
            # AI-MANAGED ì„¹ì…˜ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì˜ì—­ì— ì¶”ê°€
            echo "$PR_BODY" > updated_body.md

            # AI-MANAGED-END ë°”ë¡œ ì•ì— ìƒˆ ì—…ë°ì´íŠ¸ ì‚½ì…
            # ì„ì‹œ íŒŒì¼ ìƒì„±
            {
              echo ""
              echo "---"
              echo "## ğŸ”„ Update ($CURRENT_TIME)"
              echo "$NEW_CHANGES"
              echo ""
            } > update_section.txt

            # sedë¡œ AI-MANAGED-END ì•ì— ì‚½ì…
            awk '/<!-- AI-MANAGED-END -->/ {
              while ((getline line < "update_section.txt") > 0) {
                print line
              }
              close("update_section.txt")
            }
            {print}' updated_body.md > temp_body.md

            mv temp_body.md updated_body.md
            rm -f update_section.txt

          else
            # AI-MANAGED ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ë³¸ë¬¸ ëì— ì¶”ê°€
            {
              echo "$PR_BODY"
              echo ""
              echo "<!-- AI-MANAGED-START -->"
              echo "---"
              echo "## ğŸ”„ Update ($CURRENT_TIME)"
              echo "$NEW_CHANGES"
              echo "<!-- AI-MANAGED-END -->"
              echo ""
              echo "---"
              echo "_ğŸ¤– AIê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•œ ë‚´ìš©ì…ë‹ˆë‹¤._"
            } > updated_body.md
          fi

          # PR ë³¸ë¬¸ ì—…ë°ì´íŠ¸
          gh pr edit $PR_NUMBER --body-file updated_body.md

      # ì—…ë°ì´íŠ¸ ì™„ë£Œ í™•ì¸
      - name: Verify update
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "âœ… PR #${{ steps.pr-info.outputs.number }} ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "ğŸ“ ìƒˆ ì»¤ë°‹: ${{ github.event.after }}"
          echo "ğŸ• ì—…ë°ì´íŠ¸ ì‹œê°„: $(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')"
